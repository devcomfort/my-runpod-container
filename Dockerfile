# ============================================================================
# Multi-stage Dockerfile for Personal RunPod Environment
# Optimized for build size, speed, and storage efficiency
# ============================================================================

# === Build Arguments ===
ARG BASE_IMAGE
ARG BASE_RELEASE_VERSION

# ============================================================================
# Í∞úÎ∞ú ÎèÑÍµ¨ Î≤ÑÏ†Ñ Í¥ÄÎ¶¨ (2024ÎÖÑ 12Ïõî Í∏∞Ï§Ä ÏµúÏã† ÏïàÏ†ï Î≤ÑÏ†Ñ)
# ============================================================================
ARG GO_VERSION="1.23.4"
ARG TINYGO_VERSION="0.38.0"
ARG GH_VERSION="2.76.1"
ARG VS_CODE_VERSION="latest"
ARG INSTALL_SLURM="true"

# ============================================================================
# Stage 1: Base System Setup
# ============================================================================
FROM ${BASE_IMAGE} as base-system

# === Environment Setup ===
SHELL ["/bin/bash", "-o", "pipefail", "-c"]
ENV DEBIAN_FRONTEND=noninteractive \
    SHELL=/bin/bash \
    VSCODE_SERVE_MODE=remote \
    BASE_RELEASE_VERSION=${BASE_RELEASE_VERSION}

WORKDIR /

# === APT Mirror Optimization & System Packages Installation ===
RUN set -eux; \
    # APT ÎØ∏Îü¨ ÏÑúÎ≤Ñ ÏµúÏ†ÅÌôî (ÌïúÍµ≠)
    sed -i 's|http://archive.ubuntu.com/ubuntu|http://mirror.kakao.com/ubuntu|g' /etc/apt/sources.list && \
    sed -i 's|http://security.ubuntu.com/ubuntu|http://mirror.kakao.com/ubuntu|g' /etc/apt/sources.list && \
    \
    # APT ÏÑ§Ï†ï ÏµúÏ†ÅÌôî
    echo 'APT::Install-Recommends "false";' > /etc/apt/apt.conf.d/01norecommends && \
    echo 'APT::Install-Suggests "false";' >> /etc/apt/apt.conf.d/01norecommends && \
    echo 'APT::Acquire::Retries "3";' > /etc/apt/apt.conf.d/02retries && \
    \
    # ÏãúÏä§ÌÖú ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò (Ìïú Î≤àÏóê ÏßÑÌñâ)
    apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        # Build tools
        software-properties-common \
        build-essential \
        make \
        cmake \
        gfortran \
        # Development libraries
        libblas-dev \
        liblapack-dev \
        libatlas-base-dev \
        libffi-dev \
        libhdf5-serial-dev \
        libssl-dev \
        # Media processing
        ffmpeg \
        libavcodec-dev \
        libavfilter-dev \
        libavformat-dev \
        libavutil-dev \
        libjpeg-dev \
        libpng-dev \
        libpostproc-dev \
        libswresample-dev \
        libswscale-dev \
        libtiff-dev \
        libv4l-dev \
        libx264-dev \
        libxext6 \
        libxrender-dev \
        libxvidcore-dev \
        # System utilities
        git \
        curl \
        wget \
        unzip \
        zip \
        tree \
        htop \
        iftop \
        nano \
        # Network and services
        nginx \
        openssh-server \
        # File systems
        cifs-utils \
        nfs-common \
        zstd \
        # GUI support
        libsm6 \
        expect \
        gnome-keyring \
        ca-certificates \
        tzdata && \
    \
    # Ï∫êÏãú Ï†ïÎ¶¨
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    \
    # Î∂àÌïÑÏöîÌïú ÏãúÏä§ÌÖú ÌååÏùº Ï†ïÎ¶¨
    find /usr/share/doc -depth -type f ! -name copyright | xargs rm || true && \
    find /usr/share/man -type f | xargs rm || true && \
    find /usr/share/groff -type f | xargs rm || true && \
    find /usr/share/info -type f | xargs rm || true && \
    find /usr/share/lintian -type f | xargs rm || true && \
    find /usr/share/linda -type f | xargs rm || true

# ============================================================================
# Stage 2: Development Tools Builder
# ============================================================================
FROM base-system as dev-tools-builder

# === Development Tools Installation (Parallel where possible) ===
RUN set -eux; \
    # Create temporary directory for downloads
    mkdir -p /tmp/downloads && \
    cd /tmp/downloads && \
    \
    # VS Code Server ÏÑ§Ïπò
    curl -fsSL https://code-server.dev/install.sh | bash && \
    \
    # Î≥ëÎ†¨ Îã§Ïö¥Î°úÎìúÎ•º ÏúÑÌïú Î∞±Í∑∏ÎùºÏö¥Îìú ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë
    # Rust ÏÑ§Ïπò
    (curl -sSf https://sh.rustup.rs | sh -s -- -y) & \
    RUST_PID=$! && \
    \
    # Python Rye ÏÑ§Ïπò 
    (curl -sSf https://rye.astral.sh/get | RYE_HOME="/root/.rye" RYE_VERSION="latest" RYE_INSTALL_OPTION="--yes" bash) & \
    RYE_PID=$! && \
    \
    # Go ÏÑ§Ïπò (webinstall ÎåÄÏã† ÏßÅÏ†ë Îã§Ïö¥Î°úÎìú)
    GO_VERSION=$(echo $GO_VERSION | sed 's/v//') && \
    GO_ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/') && \
    curl -sSL "https://go.dev/dl/go${GO_VERSION}.linux-${GO_ARCH}.tar.gz" -o go.tar.gz & \
    GO_PID=$! && \
    \
    # GitHub CLI ÏÑ§Ïπò (webinstall ÎåÄÏã† ÏßÅÏ†ë Îã§Ïö¥Î°úÎìú)
    GH_VERSION=$(echo $GH_VERSION | sed 's/v//') && \
    GH_ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/') && \
    curl -sSL "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_${GH_ARCH}.tar.gz" -o gh.tar.gz & \
    GH_PID=$! && \
    \
    # Ollama ÏÑ§Ïπò (Î∞±Í∑∏ÎùºÏö¥Îìú)
    (curl -fsSL https://ollama.com/install.sh | bash) & \
    OLLAMA_PID=$! && \
    \
    # Î™®Îì† Î∞±Í∑∏ÎùºÏö¥Îìú ÏûëÏóÖ ÏôÑÎ£å ÎåÄÍ∏∞
    wait $RUST_PID && \
    wait $RYE_PID && \
    wait $GO_PID && \
    wait $GH_PID && \
    wait $OLLAMA_PID && \
    \
    # Go ÏÑ§Ïπò ÏôÑÎ£å
    tar -C /usr/local -xzf go.tar.gz && \
    \
    # GitHub CLI ÏÑ§Ïπò ÏôÑÎ£å
    tar -xzf gh.tar.gz && \
    cp gh_${GH_VERSION}_linux_${GH_ARCH}/bin/gh /usr/local/bin/ && \
    \
    # TinyGo ÏÑ§Ïπò (GoÍ∞Ä ÏÑ§ÏπòÎêú ÌõÑ)
    TINYGO_VERSION=$(echo $TINYGO_VERSION | sed 's/v//') && \
    TINYGO_ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/') && \
    curl -sSL "https://github.com/tinygo-org/tinygo/releases/download/v${TINYGO_VERSION}/tinygo${TINYGO_VERSION}.linux-${TINYGO_ARCH}.tar.gz" -o tinygo.tar.gz && \
    tar -C /usr/local -xzf tinygo.tar.gz && \
    \
    # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
    echo 'export PATH="/usr/local/go/bin:$PATH"' >> /root/.profile && \
    echo 'export PATH="/usr/local/tinygo/bin:$PATH"' >> /root/.profile && \
    echo 'source "$HOME/.cargo/env"' >> /root/.profile && \
    echo 'source /root/.rye/env' >> /root/.profile && \
    \
    # ÏûÑÏãú ÌååÏùº Ï†ïÎ¶¨
    cd / && rm -rf /tmp/downloads

# === HPC & Workflow Tools Installation ===
RUN set -eux; \
    # PATH Î°úÎìú
    source /root/.profile && \
    \
    # Rust ÎèÑÍµ¨ ÏÑ§Ïπò (memlimit)
    source "$HOME/.cargo/env" && \
    cargo install memlimit && \
    \
    # Python ÎèÑÍµ¨ ÏÑ§Ïπò
    source /root/.rye/env && \
    rye install jupyterlab && \
    rye install magic-wormhole && \
    rye install invoke && \
    \
    # Slurm ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÎèÑÍµ¨ ÏÑ§Ïπò (ÏÑ†ÌÉùÏ†Å)
    if [ "${INSTALL_SLURM:-true}" = "true" ]; then \
        apt-get update && \
        apt-get install -y --no-install-recommends \
            slurm-client \
            slurm-wlm-basic-plugins && \
        \
        # Slurm Í∏∞Î≥∏ ÏÑ§Ï†ï ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ±
        mkdir -p /etc/slurm /var/log/slurm /var/spool/slurm && \
        \
        # Í∏∞Î≥∏ slurm.conf ÌÖúÌîåÎ¶ø ÏÉùÏÑ± (Ïô∏Î∂Ä ÌÅ¥Îü¨Ïä§ÌÑ∞ Ïó∞Í≤∞Ïö©)
        cat > /etc/slurm/slurm.conf.template << 'EOF'
# Slurm Configuration Template
# Ïù¥ ÌååÏùºÏùÑ /etc/slurm/slurm.confÎ°ú Î≥µÏÇ¨ÌïòÍ≥† Ïã§Ï†ú ÌÅ¥Îü¨Ïä§ÌÑ∞ Ï†ïÎ≥¥Î°ú ÏàòÏ†ïÌïòÏÑ∏Ïöî
# 
# ClusterName=YOUR_CLUSTER_NAME
# ControlMachine=YOUR_CONTROL_NODE
# ControlAddr=YOUR_CONTROL_IP
# 
# Example:
# ClusterName=research-cluster
# ControlMachine=slurm-controller
# ControlAddr=10.0.0.100
# SlurmUser=slurm
# SlurmdUser=root
# StateSaveLocation=/var/spool/slurm/ctld
# SlurmdSpoolDir=/var/spool/slurm/d
# SwitchType=switch/none
# MpiDefault=none
# ProctrackType=proctrack/pgid
# ReturnToService=2
# TaskPlugin=task/none
# 
# # Node and Partition Configuration (ÏòàÏãú)
# NodeName=compute[001-010] CPUs=4 State=UNKNOWN
# PartitionName=debug Nodes=compute[001-010] Default=YES MaxTime=INFINITE State=UP
EOF
        \
        echo "‚úÖ Slurm client tools installed successfully" && \
        echo "üí° Configure /etc/slurm/slurm.conf to connect to your Slurm cluster"; \
    else \
        echo "‚è≠Ô∏è  Slurm installation skipped (INSTALL_SLURM=false)"; \
    fi && \
    \
    # Cargo Ï∫êÏãú Ï†ïÎ¶¨ (cargo-cacheÍ∞Ä ÏÑ§ÏπòÎêòÏñ¥ ÏûàÎã§Î©¥)
    if command -v cargo-cache >/dev/null 2>&1; then \
        cargo cache --autoclean; \
    fi && \
    rm -rf ~/.cargo/registry/cache/* ~/.cargo/git/*/refs && \
    \
    # Rye Ï∫êÏãú Ï†ïÎ¶¨
    rye cache clean --all || true && \
    \
    # APT Ï∫êÏãú Ï†ïÎ¶¨ (Slurm ÏÑ§Ïπò ÌõÑ)
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# ============================================================================
# Stage 3: Final Runtime Image
# ============================================================================
FROM base-system as final

# === Copy Development Tools from Builder ===
COPY --from=dev-tools-builder /usr/local /usr/local
COPY --from=dev-tools-builder /root/.cargo /root/.cargo
COPY --from=dev-tools-builder /root/.rye /root/.rye
COPY --from=dev-tools-builder /root/.profile /root/.profile

# === Copy Application Files ===
COPY container/src/* /usr/local/bin/
COPY container/proxy/nginx.conf /etc/nginx/nginx.conf
COPY container/proxy/readme.html /usr/share/nginx/html/readme.html
COPY README.md /usr/share/nginx/html/README.md
COPY container/scripts/post_start.sh /
COPY container/scripts/start.sh /

# === Final Configuration ===
RUN set -eux; \
    # Nginx ÏÑ§Ï†ï
    wget -O /tmp/init-deb.sh https://www.linode.com/docs/assets/660-init-deb.sh && \
    mv /tmp/init-deb.sh /etc/init.d/nginx && \
    chmod +x /etc/init.d/nginx && \
    /usr/sbin/update-rc.d -f nginx defaults && \
    \
    # Ïä§ÌÅ¨Î¶ΩÌä∏ Í∂åÌïú ÏÑ§Ï†ï
    chmod +x /start.sh && \
    chmod +x /usr/local/bin/* && \
    \
    # ÏµúÏ¢Ö Ï†ïÎ¶¨
    rm -rf /tmp/* /var/tmp/* && \
    \
    # ÌôòÍ≤Ω Î≥ÄÏàò ÌÖåÏä§Ìä∏ (ÎπåÎìú Ïãú Í≤ÄÏ¶ù)
    source /root/.profile && \
    command -v cargo >/dev/null && \
    command -v rye >/dev/null && \
    command -v go >/dev/null && \
    command -v gh >/dev/null && \
    echo "All tools installed successfully"

# === Port Exposure ===
EXPOSE 22 80 443 8000 8080

# === Default Command ===
CMD ["/start.sh"]