steps:
  - name: 'gcr.io/cloud-builders/docker'
    args: ['run', '--rm', '--privileged', 'multiarch/qemu-user-static', '--reset', '-p', 'yes']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['buildx', 'create', '--use']
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "$_DOCKERHUB_TOKEN" | docker login -u "$_DOCKERHUB_USERNAME" --password-stdin
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "RELEASE=0.2" > /workspace/.env
        echo "DOCKER_HUB_USERNAME=$_DOCKERHUB_USERNAME" >> /workspace/.env
  - name: 'gcr.io/cloud-builders/docker'
    args: ['buildx', 'bake', '-f', 'docker-bake.hcl', '--push']
options:
  machineType: 'e2-highcpu-8'  # 더 많은 CPU를 가진 인스턴스 타입
  diskSizeGb: '200'

substitutions:
  _DOCKERHUB_USERNAME: ""
  _DOCKERHUB_TOKEN: ""