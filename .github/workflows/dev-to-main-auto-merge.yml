name: ðŸš€ Dev to Main Auto-Merge

on:
  workflow_run:
    workflows: ["ðŸ³ Build and Push Multi-Architecture Images", "ðŸ§ª Shell Tests"]
    types: [completed]
    branches: [dev]

permissions:
  contents: write
  actions: read

jobs:
  auto-merge-dev-to-main:
    name: ðŸš€ Auto Merge Dev to Main
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Check if all required workflows succeeded
        id: check-workflows
        run: |
          echo "ðŸ” dev ë¸Œëžœì¹˜ì˜ ëª¨ë“  ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì—¬ë¶€ í™•ì¸..."
          
          # ìµœì‹  dev ë¸Œëžœì¹˜ ì»¤ë°‹ì˜ SHA ê°€ì ¸ì˜¤ê¸°
          DEV_SHA=$(git rev-parse dev)
          echo "Dev branch SHA: $DEV_SHA"
          
          # í•„ìˆ˜ ì›Œí¬í”Œë¡œìš°ë“¤ì´ ëª¨ë‘ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
          REQUIRED_WORKFLOWS=("ðŸ³ Build and Push Multi-Architecture Images" "ðŸ§ª Shell Tests")
          ALL_SUCCESS=true
          
          for workflow in "${REQUIRED_WORKFLOWS[@]}"; do
            echo "ðŸ” $workflow ìƒíƒœ í™•ì¸ ì¤‘..."
            
            # í•´ë‹¹ ì›Œí¬í”Œë¡œìš°ì˜ ìµœì‹  ì‹¤í–‰ ê²°ê³¼ í™•ì¸
            CONCLUSION=$(gh api repos/${{ github.repository }}/actions/workflows \
              --jq ".workflows[] | select(.name == \"$workflow\") | .id" | \
              xargs -I {} gh api repos/${{ github.repository }}/actions/workflows/{}/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$DEV_SHA\") | .conclusion" | head -n1)
            
            echo "  - $workflow: $CONCLUSION"
            
            if [[ "$CONCLUSION" != "success" ]]; then
              echo "âŒ $workflowê°€ ì„±ê³µí•˜ì§€ ì•ŠìŒ: $CONCLUSION"
              ALL_SUCCESS=false
              break
            fi
          done
          
          if [[ "$ALL_SUCCESS" == "true" ]]; then
            echo "âœ… ëª¨ë“  í•„ìˆ˜ ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
            echo "should_merge=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ì¼ë¶€ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            echo "should_merge=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Direct merge to main
        if: steps.check-workflows.outputs.should_merge == 'true'
        run: |
          echo "ðŸš€ dev â†’ main ì§ì ‘ ë¨¸ì§€ ì‹œìž‘..."
          
          # Git ì‚¬ìš©ìž ì„¤ì •
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # main ë¸Œëžœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
          git checkout main
          git pull origin main
          
          # dev ë¸Œëžœì¹˜ ë‚´ìš©ì„ mainì— ë¨¸ì§€
          echo "ðŸ”„ dev ë¸Œëžœì¹˜ë¥¼ mainì— ë¨¸ì§€ ì¤‘..."
          git merge origin/dev --no-ff -m "ðŸ¤– Auto-merge dev to main

          âœ… ëª¨ë“  ì²´í¬ í†µê³¼:
          - ðŸ§ª Shell í…ŒìŠ¤íŠ¸: ì„±ê³µ
          - ðŸ³ Docker ë¹Œë“œ: ì„±ê³µ
          
          ðŸ“‹ ìµœì‹  ì»¤ë°‹: $(git log --oneline -1 dev)"
          
          # main ë¸Œëžœì¹˜ì— push
          git push origin main
          
          echo "ðŸŽ‰ dev ë¸Œëžœì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ mainìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify merge failure
        if: steps.check-workflows.outputs.should_merge != 'true'
        run: |
          echo "âŒ dev â†’ main ìžë™ ë¨¸ì§€ ì‹¤íŒ¨"
          echo "ì¼ë¶€ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          
          echo "ðŸ” ì‹¤íŒ¨ ì›ì¸ì„ í™•ì¸í•˜ì„¸ìš”:"
          echo "  - ðŸ³ Build and Push ì›Œí¬í”Œë¡œìš° ìƒíƒœ"
          echo "  - ðŸ§ª Shell Tests ì›Œí¬í”Œë¡œìš° ìƒíƒœ"

  # ðŸ“Š ë¨¸ì§€ ê²°ê³¼ ìš”ì•½
  merge-summary:
    name: ðŸ“Š Dev to Main Merge Summary
    runs-on: ubuntu-latest
    needs: [auto-merge-dev-to-main]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Dev to Main ì§ì ‘ ë¨¸ì§€ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.auto-merge-dev-to-main.result }}" == "success" ]]; then
            echo "âœ… **ì§ì ‘ ë¨¸ì§€ ì„±ê³µ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "dev ë¸Œëžœì¹˜ì˜ ëª¨ë“  ì²´í¬ê°€ í†µê³¼í•˜ì—¬ main ë¸Œëžœì¹˜ë¡œ ì§ì ‘ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš€ **ìž¥ì **: PR ë‹¨ê³„ ì—†ì´ ë¹ ë¥¸ ë°°í¬" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.auto-merge-dev-to-main.result }}" == "skipped" ]]; then
            echo "â­ï¸ **ë¨¸ì§€ ê±´ë„ˆëœ€**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•Šì•„ ë¨¸ì§€ê°€ ê±´ë„ˆë›°ì–´ì¡ŒìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ìžë™ ë¨¸ì§€ ì‹¤íŒ¨**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ìžë™ ë¨¸ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ìžë™ ë¨¸ì§€ ì¡°ê±´" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… dev ë¸Œëžœì¹˜ì—ì„œ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ðŸ³ Docker ë¹Œë“œ ë° í‘¸ì‹œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ðŸ§ª Shell í…ŒìŠ¤íŠ¸ í†µê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **No PR**: ì§ì ‘ main ë¸Œëžœì¹˜ì— ë¨¸ì§€" >> $GITHUB_STEP_SUMMARY 