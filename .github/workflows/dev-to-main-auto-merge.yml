name: ðŸš€ Dev to Main Auto-Merge

on:
  workflow_run:
    workflows: ["ðŸ³ Build and Push Multi-Architecture Images", "ðŸ§ª Shell Tests"]
    types: [completed]
    branches: [dev]

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  auto-merge-dev-to-main:
    name: ðŸš€ Auto Merge Dev to Main
    runs-on: ubuntu-latest
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: Check if all required workflows succeeded
        id: check-workflows
        run: |
          echo "ðŸ” dev ë¸Œëžœì¹˜ì˜ ëª¨ë“  ì›Œí¬í”Œë¡œìš° ì„±ê³µ ì—¬ë¶€ í™•ì¸..."
          
          # ìµœì‹  dev ë¸Œëžœì¹˜ ì»¤ë°‹ì˜ SHA ê°€ì ¸ì˜¤ê¸°
          DEV_SHA=$(git rev-parse dev)
          echo "Dev branch SHA: $DEV_SHA"
          
          # í•„ìˆ˜ ì›Œí¬í”Œë¡œìš°ë“¤ì´ ëª¨ë‘ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
          REQUIRED_WORKFLOWS=("ðŸ³ Build and Push Multi-Architecture Images" "ðŸ§ª Shell Tests")
          ALL_SUCCESS=true
          
          for workflow in "${REQUIRED_WORKFLOWS[@]}"; do
            echo "ðŸ” $workflow ìƒíƒœ í™•ì¸ ì¤‘..."
            
            # í•´ë‹¹ ì›Œí¬í”Œë¡œìš°ì˜ ìµœì‹  ì‹¤í–‰ ê²°ê³¼ í™•ì¸
            CONCLUSION=$(gh api repos/${{ github.repository }}/actions/workflows \
              --jq ".workflows[] | select(.name == \"$workflow\") | .id" | \
              xargs -I {} gh api repos/${{ github.repository }}/actions/workflows/{}/runs \
              --jq ".workflow_runs[] | select(.head_sha == \"$DEV_SHA\") | .conclusion" | head -n1)
            
            echo "  - $workflow: $CONCLUSION"
            
            if [[ "$CONCLUSION" != "success" ]]; then
              echo "âŒ $workflowê°€ ì„±ê³µí•˜ì§€ ì•ŠìŒ: $CONCLUSION"
              ALL_SUCCESS=false
              break
            fi
          done
          
          if [[ "$ALL_SUCCESS" == "true" ]]; then
            echo "âœ… ëª¨ë“  í•„ìˆ˜ ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤!"
            echo "should_merge=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ì¼ë¶€ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
            echo "should_merge=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create and merge PR to main
        if: steps.check-workflows.outputs.should_merge == 'true'
        run: |
          echo "ðŸš€ dev â†’ main ìžë™ ë¨¸ì§€ ì‹œìž‘..."
          
          # ê¸°ì¡´ dev â†’ main PRì´ ìžˆëŠ”ì§€ í™•ì¸
          EXISTING_PR=$(gh pr list --base main --head dev --state open --json number --jq '.[0].number // empty')
          
          if [[ -n "$EXISTING_PR" ]]; then
            echo "ðŸ“‹ ê¸°ì¡´ PR #$EXISTING_PR ë°œê²¬"
            PR_NUMBER=$EXISTING_PR
          else
            echo "ðŸ†• ìƒˆë¡œìš´ PR ìƒì„± ì¤‘..."
            
            # ìµœì‹  ì»¤ë°‹ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
            COMMIT_MSG=$(git log --oneline -1 dev | cut -d' ' -f2-)
            
            # PR ìƒì„±
            PR_NUMBER=$(gh pr create \
              --base main \
              --head dev \
              --title "ðŸš€ Auto-merge: $COMMIT_MSG" \
              --body "ðŸ¤– **ìžë™ ìƒì„±ëœ PR**

            ì´ PRì€ dev ë¸Œëžœì¹˜ì˜ ëª¨ë“  í…ŒìŠ¤íŠ¸ì™€ ë¹Œë“œê°€ ì„±ê³µí•œ í›„ ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

            ## âœ… í†µê³¼í•œ ì²´í¬
            - ðŸ³ Docker ë¹Œë“œ ë° í‘¸ì‹œ: âœ… ì„±ê³µ
            - ðŸ§ª Shell í…ŒìŠ¤íŠ¸: âœ… ì„±ê³µ

            ## ðŸ“‹ ë³€ê²½ì‚¬í•­
            - ìµœì‹  ì»¤ë°‹: \`$(git log --oneline -1 dev)\`
            - ë¸Œëžœì¹˜: \`dev\` â†’ \`main\`

            ðŸ”„ ìžë™ ë¨¸ì§€ê°€ ê³§ ì§„í–‰ë©ë‹ˆë‹¤..." \
              --json number --jq '.number')
            
            echo "âœ… PR #$PR_NUMBER ìƒì„± ì™„ë£Œ"
          fi
          
          # PR ìžë™ ìŠ¹ì¸
          echo "âœ… PR #$PR_NUMBER ìžë™ ìŠ¹ì¸ ì¤‘..."
          gh pr review $PR_NUMBER --approve --body "ðŸ¤– ëª¨ë“  ì²´í¬ê°€ í†µê³¼í•˜ì—¬ ìžë™ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."
          
          # PR ë¨¸ì§€ (squash merge)
          echo "ðŸ”„ PR #$PR_NUMBER ë¨¸ì§€ ì¤‘..."
          gh pr merge $PR_NUMBER --squash --auto --delete-branch=false
          
          echo "ðŸŽ‰ dev ë¸Œëžœì¹˜ê°€ ì„±ê³µì ìœ¼ë¡œ mainìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify merge failure
        if: steps.check-workflows.outputs.should_merge != 'true'
        run: |
          echo "âŒ dev â†’ main ìžë™ ë¨¸ì§€ ì‹¤íŒ¨"
          echo "ì¼ë¶€ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          
          # GitHub ì´ìŠˆë‚˜ ì•Œë¦¼ì„ í†µí•´ ì‹¤íŒ¨ í†µì§€ (ì„ íƒì‚¬í•­)
          echo "ðŸ” ì‹¤íŒ¨ ì›ì¸ì„ í™•ì¸í•˜ì„¸ìš”:"
          echo "  - ðŸ³ Build and Push ì›Œí¬í”Œë¡œìš° ìƒíƒœ"
          echo "  - ðŸ§ª Shell Tests ì›Œí¬í”Œë¡œìš° ìƒíƒœ"

  # ðŸ“Š ë¨¸ì§€ ê²°ê³¼ ìš”ì•½
  merge-summary:
    name: ðŸ“Š Dev to Main Merge Summary
    runs-on: ubuntu-latest
    needs: [auto-merge-dev-to-main]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Dev to Main ìžë™ ë¨¸ì§€ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.auto-merge-dev-to-main.result }}" == "success" ]]; then
            echo "âœ… **ìžë™ ë¨¸ì§€ ì„±ê³µ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "dev ë¸Œëžœì¹˜ì˜ ëª¨ë“  ì²´í¬ê°€ í†µê³¼í•˜ì—¬ main ë¸Œëžœì¹˜ë¡œ ì„±ê³µì ìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.auto-merge-dev-to-main.result }}" == "skipped" ]]; then
            echo "â­ï¸ **ë¨¸ì§€ ê±´ë„ˆëœ€**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•Šì•„ ë¨¸ì§€ê°€ ê±´ë„ˆë›°ì–´ì¡ŒìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ìžë™ ë¨¸ì§€ ì‹¤íŒ¨**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ìžë™ ë¨¸ì§€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ìžë™ ë¨¸ì§€ ì¡°ê±´" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… dev ë¸Œëžœì¹˜ì—ì„œ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ðŸ³ Docker ë¹Œë“œ ë° í‘¸ì‹œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ðŸ§ª Shell í…ŒìŠ¤íŠ¸ í†µê³¼" >> $GITHUB_STEP_SUMMARY 