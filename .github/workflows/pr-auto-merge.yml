name: ðŸ¤– PR Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]
  workflow_run:
    workflows: ["ðŸ³ Build and Push Multi-Architecture Images", "ðŸ§ª Shell Tests"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  checks: read
  actions: read

jobs:
  # ðŸ” PR ìƒíƒœ ë° ìžê²© ìš”ê±´ ì²´í¬
  check-pr-requirements:
    name: ðŸ” Check PR Requirements
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      should_automerge: ${{ steps.check.outputs.should_automerge }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check PR requirements
        id: check
        run: |
          echo "ðŸ” PR ìžê²© ìš”ê±´ í™•ì¸ ì¤‘..."
          
          # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_DRAFT="${{ github.event.pull_request.draft }}"
          PR_MERGEABLE="${{ github.event.pull_request.mergeable }}"
          
          echo "ðŸ“‹ PR ì •ë³´:"
          echo "  - PR Number: $PR_NUMBER"
          echo "  - Author: $PR_AUTHOR"
          echo "  - Draft: $PR_DRAFT"
          echo "  - Mergeable: $PR_MERGEABLE"
          
          # ìžë™ ë¨¸ì§€ ê°€ëŠ¥ ì—¬ë¶€ íŒë‹¨
          SHOULD_AUTOMERGE="false"
          
          # Draft PRì€ ìžë™ ë¨¸ì§€í•˜ì§€ ì•ŠìŒ
          if [[ "$PR_DRAFT" == "true" ]]; then
            echo "âŒ Draft PRì€ ìžë™ ë¨¸ì§€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
          # Mergeableí•˜ì§€ ì•Šìœ¼ë©´ ìžë™ ë¨¸ì§€í•˜ì§€ ì•ŠìŒ
          elif [[ "$PR_MERGEABLE" == "false" ]]; then
            echo "âŒ ì¶©ëŒì´ ìžˆì–´ ìžë™ ë¨¸ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
          else
            echo "âœ… ìžë™ ë¨¸ì§€ ìžê²© ìš”ê±´ì„ ë§Œì¡±í•©ë‹ˆë‹¤"
            SHOULD_AUTOMERGE="true"
          fi
          
          echo "should_automerge=$SHOULD_AUTOMERGE" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

  # â³ ëª¨ë“  ì²´í¬ ì™„ë£Œ ëŒ€ê¸° ë° ë¨¸ì§€ ì‹¤í–‰
  auto-merge:
    name: ðŸ¤– Auto Merge
    runs-on: ubuntu-latest
    needs: [check-pr-requirements]
    if: |
      always() && 
      (github.event_name == 'workflow_run' || needs.check-pr-requirements.outputs.should_automerge == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get PR information
        id: pr-info
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            # workflow_run ì´ë²¤íŠ¸ì—ì„œ PR ì •ë³´ ì°¾ê¸°
            PR_NUMBER=$(gh pr list --state open --base main --json number,headRefName | jq -r ".[] | select(.headRefName == \"${{ github.event.workflow_run.head_branch }}\") | .number")
          else
            PR_NUMBER="${{ needs.check-pr-requirements.outputs.pr_number }}"
          fi
          
          if [[ -z "$PR_NUMBER" || "$PR_NUMBER" == "null" ]]; then
            echo "âŒ ì—°ê´€ëœ PRì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ ì²˜ë¦¬í•  PR: #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Wait for all checks to complete
        id: wait-checks
        run: |
          echo "â³ ëª¨ë“  ì²´í¬ ì™„ë£Œ ëŒ€ê¸° ì¤‘..."
          
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          MAX_WAIT=1800  # 30ë¶„ ìµœëŒ€ ëŒ€ê¸°
          WAIT_INTERVAL=30  # 30ì´ˆ ê°„ê²©
          elapsed=0
          
          while [[ $elapsed -lt $MAX_WAIT ]]; do
            echo "ðŸ” ì²´í¬ ìƒíƒœ í™•ì¸ ì¤‘... (ê²½ê³¼ ì‹œê°„: ${elapsed}s)"
            
            # PRì˜ ëª¨ë“  ì²´í¬ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
            CHECK_RUNS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/commits | jq -r '.[0].sha' | xargs -I {} gh api repos/${{ github.repository }}/commits/{}/check-runs --jq '.check_runs')
            
            # í•„ìˆ˜ ì›Œí¬í”Œë¡œìš° ì²´í¬
            REQUIRED_CHECKS=("ðŸ³ Build and Push Multi-Architecture Images" "ðŸ§ª Shell Tests")
            ALL_PASSED=true
            PENDING_CHECKS=()
            
            for check_name in "${REQUIRED_CHECKS[@]}"; do
              STATUS=$(echo "$CHECK_RUNS" | jq -r ".[] | select(.name == \"$check_name\") | .status")
              CONCLUSION=$(echo "$CHECK_RUNS" | jq -r ".[] | select(.name == \"$check_name\") | .conclusion")
              
              echo "  - $check_name: $STATUS ($CONCLUSION)"
              
              if [[ "$STATUS" == "in_progress" || "$STATUS" == "queued" ]]; then
                PENDING_CHECKS+=("$check_name")
                ALL_PASSED=false
              elif [[ "$CONCLUSION" != "success" ]]; then
                echo "âŒ $check_name ì²´í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: $CONCLUSION"
                echo "all_checks_passed=false" >> $GITHUB_OUTPUT
                exit 0
              fi
            done
            
            if [[ "$ALL_PASSED" == "true" ]]; then
              echo "âœ… ëª¨ë“  í•„ìˆ˜ ì²´í¬ê°€ í†µê³¼í–ˆìŠµë‹ˆë‹¤!"
              echo "all_checks_passed=true" >> $GITHUB_OUTPUT
              break
            fi
            
            echo "â³ ëŒ€ê¸° ì¤‘ì¸ ì²´í¬: ${PENDING_CHECKS[*]}"
            sleep $WAIT_INTERVAL
            elapsed=$((elapsed + WAIT_INTERVAL))
          done
          
          if [[ $elapsed -ge $MAX_WAIT ]]; then
            echo "â° ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼"
            echo "all_checks_passed=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Auto-approve and merge PR
        if: steps.wait-checks.outputs.all_checks_passed == 'true'
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          
          echo "ðŸŽ¯ PR #$PR_NUMBER ìžë™ ìŠ¹ì¸ ë° ë¨¸ì§€ ì‹¤í–‰..."
          
          # PR ìŠ¹ì¸
          echo "âœ… PR ìŠ¹ì¸ ì¤‘..."
          gh pr review $PR_NUMBER --approve --body "ðŸ¤– ëª¨ë“  ì²´í¬ê°€ í†µê³¼í•˜ì—¬ ìžë™ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.

          âœ… **í†µê³¼í•œ ì²´í¬:**
          - ðŸ³ Docker ë¹Œë“œ ë° í‘¸ì‹œ
          - ðŸ§ª Shell í…ŒìŠ¤íŠ¸
          
          ðŸš€ ìžë™ ë¨¸ì§€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
          
          # PR ë¨¸ì§€ (squash merge ì‚¬ìš©)
          echo "ðŸ”„ PR ë¨¸ì§€ ì¤‘..."
          gh pr merge $PR_NUMBER --squash --auto --delete-branch
          
          echo "ðŸŽ‰ PR #$PR_NUMBERì´ ì„±ê³µì ìœ¼ë¡œ main ë¸Œëžœì¹˜ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Notify merge failure
        if: steps.wait-checks.outputs.all_checks_passed != 'true'
        run: |
          PR_NUMBER="${{ steps.pr-info.outputs.pr_number }}"
          
          echo "âŒ PR #$PR_NUMBER ìžë™ ë¨¸ì§€ ì‹¤íŒ¨"
          
          # PRì— ì‹¤íŒ¨ ì‚¬ìœ  ì½”ë©˜íŠ¸ ì¶”ê°€
          gh pr comment $PR_NUMBER --body "âŒ **ìžë™ ë¨¸ì§€ ì‹¤íŒ¨**

          ì¼ë¶€ ì²´í¬ê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ì™„ë£Œë˜ì§€ ì•Šì•„ ìžë™ ë¨¸ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

          ðŸ” **í™•ì¸ì‚¬í•­:**
          - ëª¨ë“  ì²´í¬ê°€ í†µê³¼í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
          - ì¶©ëŒì´ ìžˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”
          - Draft ìƒíƒœê°€ ì•„ë‹Œì§€ í™•ì¸í•´ì£¼ì„¸ìš”
          
          âœ… ëª¨ë“  ë¬¸ì œë¥¼ í•´ê²°í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•˜ë©´ ìžë™ ë¨¸ì§€ê°€ ìž¬ì‹œë„ë©ë‹ˆë‹¤."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ðŸ“Š ë¨¸ì§€ ê²°ê³¼ ìš”ì•½
  merge-summary:
    name: ðŸ“Š Merge Summary
    runs-on: ubuntu-latest
    needs: [auto-merge]
    if: always()
    steps:
      - name: Generate merge summary
        run: |
          echo "## ðŸ¤– PR ìžë™ ë¨¸ì§€ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.auto-merge.result }}" == "success" ]]; then
            echo "âœ… **ìžë™ ë¨¸ì§€ ì„±ê³µ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ëª¨ë“  ì²´í¬ê°€ í†µê³¼í•˜ì—¬ PRì´ ì„±ê³µì ìœ¼ë¡œ main ë¸Œëžœì¹˜ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ìžë™ ë¨¸ì§€ ì‹¤íŒ¨**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ì¼ë¶€ ì²´í¬ê°€ ì‹¤íŒ¨í–ˆê±°ë‚˜ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•˜ì§€ ì•Šì•„ ìžë™ ë¨¸ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ìžë™ ë¨¸ì§€ ì¡°ê±´" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ðŸ³ Docker ë¹Œë“œ ë° í‘¸ì‹œ ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ðŸ§ª Shell í…ŒìŠ¤íŠ¸ í†µê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Draft ìƒíƒœê°€ ì•„ë‹˜" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ì¶©ëŒì´ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY 