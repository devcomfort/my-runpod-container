name: ðŸ§ª Shell Tests

on:
  push:
    paths:
      - '**.sh'
      - 'dev-tools/**'
      - 'container/scripts/**'
      - 'container/src/**'
      - 'tests/**'
      - 'run_shell_tests.sh'
      - '.versions.env'
  pull_request:
    paths:
      - '**.sh'
      - 'dev-tools/**'
      - 'container/scripts/**'
      - 'container/src/**'
      - 'tests/**'
      - 'run_shell_tests.sh'
      - '.versions.env'
  workflow_dispatch:

jobs:
  # ðŸ§ª ë¹ ë¥¸ Shell í…ŒìŠ¤íŠ¸
  shell-tests:
    name: ðŸ§ª Shell Tests (${{ matrix.category }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        category: ['unit', 'mocked', 'integration']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup test environment
        run: |
          echo "ðŸ”§ Setting up test environment..."
          
          # Bashunit ì„¤ì¹˜
          if [ ! -f lib/bashunit ]; then
            echo "ðŸ“¦ Installing Bashunit..."
            curl -s https://bashunit.typeddevs.com/install.sh | bash
            mkdir -p lib
            mv bashunit lib/
          fi
          chmod +x lib/bashunit
          
          # ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
          find . -name "*.sh" -type f -exec chmod +x {} \;
          
          echo "âœ… Test environment ready"
          
      - name: Validate test structure
        run: |
          echo "ðŸ” Validating test structure..."
          
          # í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
          required_dirs=("tests/unit" "tests/unit_mocked" "tests/integration" "tests/helpers")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ Required test directory missing: $dir"
              exit 1
            fi
          done
          
          # í…ŒìŠ¤íŠ¸ íŒŒì¼ ê°œìˆ˜ í™•ì¸
          unit_tests=$(find tests/unit -name "*_test.sh" | wc -l)
          mocked_tests=$(find tests/unit_mocked -name "*_test.sh" | wc -l)
          integration_tests=$(find tests/integration -name "*_test.sh" | wc -l)
          
          echo "ðŸ“Š Test file counts:"
          echo "  - Unit tests: $unit_tests"
          echo "  - Mocked tests: $mocked_tests"
          echo "  - Integration tests: $integration_tests"
          echo "  - Total: $((unit_tests + mocked_tests + integration_tests))"
          
      - name: Run Unit Tests
        if: matrix.category == 'unit'
        run: |
          echo "ðŸ§ª Running Unit Tests..."
          ./run_shell_tests.sh --unit-only --verbose
          
      - name: Run Mocked Tests
        if: matrix.category == 'mocked'
        run: |
          echo "ðŸŽ­ Running Mocked Tests..."
          ./run_shell_tests.sh --mocked-only --verbose
          
      - name: Run Integration Tests
        if: matrix.category == 'integration'
        run: |
          echo "ðŸ³ Running Integration Tests..."
          FORCE_INTEGRATION=true ./run_shell_tests.sh --integration --verbose
        continue-on-error: true  # Docker daemon ì´ìŠˆë¡œ ì‹¤íŒ¨í•  ìˆ˜ ìžˆìŒ
        
      - name: Test Results Summary
        if: always()
        run: |
          echo "## ðŸ§ª ${{ matrix.category }} Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "âœ… **Status**: All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Some tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Category**: ${{ matrix.category }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Command**: \`./run_shell_tests.sh --${{ matrix.category }}-only\`" >> $GITHUB_STEP_SUMMARY

  # ðŸ” ìŠ¤í¬ë¦½íŠ¸ í’ˆì§ˆ ê²€ì‚¬
  script-quality:
    name: ðŸ” Script Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
      - name: Run ShellCheck
        run: |
          echo "ðŸ” Running ShellCheck on all shell scripts..."
          
          # ëª¨ë“  .sh íŒŒì¼ì— ëŒ€í•´ ShellCheck ì‹¤í–‰
          find . -name "*.sh" -type f | while read -r script; do
            echo "Checking: $script"
            shellcheck "$script" || echo "âš ï¸ Issues found in $script"
          done
          
      - name: Validate script syntax
        run: |
          echo "ðŸ”§ Validating shell script syntax..."
          
          # ëª¨ë“  .sh íŒŒì¼ì˜ êµ¬ë¬¸ ê²€ì¦
          error_count=0
          find . -name "*.sh" -type f | while read -r script; do
            if ! bash -n "$script"; then
              echo "âŒ Syntax error in: $script"
              ((error_count++))
            fi
          done
          
          if [ $error_count -eq 0 ]; then
            echo "âœ… All shell scripts have valid syntax"
          else
            echo "âŒ Found $error_count scripts with syntax errors"
            exit 1
          fi
          
      - name: Check for best practices
        run: |
          echo "ðŸ“‹ Checking shell script best practices..."
          
          # set -e ì‚¬ìš© í™•ì¸
          scripts_without_set_e=$(find . -name "*.sh" -type f -exec grep -L "set -e" {} \; | wc -l)
          echo "Scripts without 'set -e': $scripts_without_set_e"
          
          # shebang í™•ì¸
          scripts_without_shebang=$(find . -name "*.sh" -type f -exec head -1 {} \; | grep -v "^#!/" | wc -l)
          echo "Scripts without proper shebang: $scripts_without_shebang"

  # ðŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
  test-coverage:
    name: ðŸ“Š Test Coverage Report
    runs-on: ubuntu-latest
    needs: [shell-tests]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Generate coverage report
        run: |
          echo "ðŸ“Š Generating test coverage report..."
          
          # ì „ì²´ í•¨ìˆ˜ ìˆ˜ ê³„ì‚°
          total_functions=0
          tested_functions=0
          
          # ê° ìŠ¤í¬ë¦½íŠ¸ì˜ í•¨ìˆ˜ ê°œìˆ˜ í™•ì¸
          scripts=("setup_multi_architecture_build.sh" "dev-tools/check-dev-requirements.sh" "container/scripts/start.sh")
          
          for script in "${scripts[@]}"; do
            if [[ -f "$script" ]]; then
              func_count=$(grep -c "^[a-zA-Z_][a-zA-Z0-9_]*() {" "$script" || echo 0)
              total_functions=$((total_functions + func_count))
              echo "Functions in $script: $func_count"
            fi
          done
          
          # í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ìˆ˜ í™•ì¸
          test_cases=$(find tests/ -name "*_test.sh" -exec grep -c "^test_" {} \; | awk '{sum+=$1} END {print sum}')
          
          echo "## ðŸ“Š Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Functions | $total_functions |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Cases | $test_cases |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Files | $(find tests/ -name "*_test.sh" | wc -l) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ§ª **Unit Tests**: $(find tests/unit -name "*_test.sh" | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŽ­ **Mocked Tests**: $(find tests/unit_mocked -name "*_test.sh" | wc -l) files" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ **Integration Tests**: $(find tests/integration -name "*_test.sh" | wc -l) files" >> $GITHUB_STEP_SUMMARY

  # ðŸŽ¯ ê²°ê³¼ ìš”ì•½
  test-summary:
    name: ðŸŽ¯ Test Summary
    runs-on: ubuntu-latest
    needs: [shell-tests, script-quality, test-coverage]
    if: always()
    steps:
      - name: Test workflow summary
        run: |
          echo "# ðŸŽŠ Shell Tests Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Results Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Shell Tests | ${{ needs.shell-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Script Quality | ${{ needs.script-quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Coverage Report | ${{ needs.test-coverage.result == 'success' && 'âœ… Generated' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.shell-tests.result }}" == "success" && "${{ needs.script-quality.result }}" == "success" ]]; then
            echo "ðŸŽ‰ **All shell tests and quality checks passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Your shell scripts are:" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Functionally correct" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Following best practices" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Well tested" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Some issues were found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the failed jobs for details." >> $GITHUB_STEP_SUMMARY
          fi 